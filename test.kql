// Let's test the join logic step by step
// First, let's see what happens when we do the join but show ALL results

resources
| where type =~ 'Microsoft.Storage/storageAccounts'
| extend backupTag = tostring(tags['backup'])
| where isnull(tags['backup']) or backupTag != "none"
| extend resourceId = tolower(tostring(id))
| join kind=leftouter (
    RecoveryServicesResources
    | where type =~ 'Microsoft.DataProtection/backupVaults/backupInstances'
    | where tostring(properties.dataSourceInfo.datasourceType) =~ "Microsoft.Storage/storageAccounts/blobServices"
    | extend dataSourceId = tolower(tostring(properties.dataSourceInfo.resourceID))
    | project dataSourceId
)
on $left.resourceId == $right.dataSourceId
| project 
    StorageAccountName = name,
    ResourceGroup = resourceGroup,
    BackupTag = backupTag,
    HasBackup = iif(isnull(dataSourceId), "❌ No Backup", "✅ Has Backup"),
    StorageResourceId = resourceId,
    BackupDataSourceId = dataSourceId
| sort by HasBackup desc, StorageAccountName asc
