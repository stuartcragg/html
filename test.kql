// Diagnostic query to understand the backup vault structure and storage accounts
// Run this first to see what we're working with

// Part 1: Show all storage accounts with their tag status
resources
| where type =~ 'Microsoft.Storage/storageAccounts'
| extend backupTag = tostring(tags['backup'])
| project 
    StorageAccountName = name,
    ResourceGroup = resourceGroup,
    BackupTag = backupTag,
    HasBackupTag = isnotempty(backupTag),
    AllTags = tags,
    ResourceId = tolower(id)
| sort by StorageAccountName asc

// Uncomment the section below after running the above to see backup vault items
/*
// Part 2: Show all backup vault items to understand the structure
RecoveryServicesResources
| where type contains "backupVaults" or type contains "DataProtection"
| project 
    BackupItemType = type,
    BackupItemName = name,
    Properties = properties,
    DataSourceId = tolower(tostring(properties.dataSourceInfo.resourceID)),
    AlternateDataSourceId = tolower(tostring(properties.sourceResourceId))
| sort by BackupItemType asc
*/
