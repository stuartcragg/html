// Comprehensive query to check Storage Accounts backup configuration
// Checks both tags and actual backup/soft delete settings
// Excludes storage accounts with 'backup:none' tag

resources
| where type == "microsoft.storage/storageaccounts"
| extend backupTag = tostring(tags['backup'])
| where backupTag != "none"  // Exclude accounts explicitly tagged as backup:none
| extend 
    // Extract blob service properties for backup and soft delete settings
    blobProperties = properties.blobRestorePolicy,
    softDeleteProperties = properties.deleteRetentionPolicy,
    // Check if point-in-time restore is enabled (indicates Azure Backup for blobs)
    pointInTimeRestoreEnabled = tobool(properties.blobRestorePolicy.enabled),
    pointInTimeRestoreDays = toint(properties.blobRestorePolicy.days),
    // Check soft delete settings
    softDeleteEnabled = tobool(properties.deleteRetentionPolicy.enabled),
    softDeleteDays = toint(properties.deleteRetentionPolicy.days),
    // Additional backup-related properties
    isVersioningEnabled = tobool(properties.isVersioningEnabled),
    changeFeedEnabled = tobool(properties.changeFeed.enabled)
| project 
    StorageAccountName = name,
    ResourceGroup = resourceGroup,
    Location = location,
    SubscriptionId = subscriptionId,
    BackupTag = backupTag,
    // Backup Status
    AzureBackupForBlobs = case(
        isnull(pointInTimeRestoreEnabled), "Unknown/Not Configured",
        pointInTimeRestoreEnabled == true, strcat("Enabled (", pointInTimeRestoreDays, " days)"),
        "Disabled"
    ),
    // Soft Delete Status  
    SoftDeleteForBlobs = case(
        isnull(softDeleteEnabled), "Unknown/Not Configured", 
        softDeleteEnabled == true, strcat("Enabled (", softDeleteDays, " days)"),
        "Disabled"
    ),
    // Additional protective features
    VersioningEnabled = case(isnull(isVersioningEnabled), "Unknown", tostring(isVersioningEnabled)),
    ChangeFeedEnabled = case(isnull(changeFeedEnabled), "Unknown", tostring(changeFeedEnabled)),
    // Overall backup readiness assessment
    BackupReadiness = case(
        pointInTimeRestoreEnabled == true and softDeleteEnabled == true, "✅ Fully Protected",
        pointInTimeRestoreEnabled == true and softDeleteEnabled != true, "⚠️ Backup Enabled, No Soft Delete",
        pointInTimeRestoreEnabled != true and softDeleteEnabled == true, "⚠️ Soft Delete Only",
        "❌ No Protection Configured"
    ),
    ResourceId = id
| sort by BackupReadiness desc, StorageAccountName asc
