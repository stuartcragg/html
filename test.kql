// Query to find Storage Accounts without backup by joining directly
// with backup instances in Azure Backup Vaults
// Excludes storage accounts with 'backup:none' tag

resources
| where type =~ 'Microsoft.Storage/storageAccounts'
| extend backupTag = tostring(tags['backup'])
| where backupTag != "none"  // Exclude explicitly excluded accounts
| extend resourceId = tolower(tostring(id))
| join kind=leftouter (
    RecoveryServicesResources
    | where type =~ 'Microsoft.DataProtection/backupVaults/backupInstances'
    | extend dataSourceId = tolower(tostring(properties.dataSourceInfo.resourceID))
    | where isnotempty(dataSourceId)
    | where dataSourceId contains "microsoft.storage/storageaccounts"
    | project dataSourceId, backupInstanceName = name, vaultName = split(id, '/')[8]
)
on $left.resourceId == $right.dataSourceId
| where isnull(dataSourceId)  // Storage accounts without backup
| project 
    StorageAccountName = name,
    ResourceGroup = resourceGroup,
    Location = location,
    SubscriptionId = subscriptionId,
    BackupTag = backupTag,
    BackupStatus = "‚ùå No Backup Configured",
    ShouldHaveBackup = case(
        isempty(backupTag), "‚ö†Ô∏è No backup tag - needs review",
        backupTag == "weekly", "‚ùå Tagged for backup but not configured",
        strcat("üîç Has tag '", backupTag, "' - verify if backup needed")
    ),
    ResourceId = resourceId
| sort by ShouldHaveBackup desc, StorageAccountName asc
