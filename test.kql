// Query to find Storage Accounts that do NOT have backup enabled in Azure Backup Vault
// Excludes storage accounts with 'backup:none' tag
// Uses left join to identify storage accounts not found in backup vault protected items

resources
| where type =~ 'Microsoft.Storage/storageAccounts'
| extend backupTag = tostring(tags['backup'])
| where backupTag != "none"  // Exclude accounts explicitly tagged as backup:none
| extend resourceId = tolower(tostring(id))
| join kind=leftouter (
    RecoveryServicesResources
    | where type =~ 'Microsoft.DataProtection/backupVaults/backupInstances'
       or type =~ 'Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems'
    | extend dataSourceId = tolower(tostring(
        coalesce(
            properties.dataSourceInfo.resourceID,
            properties.dataSourceInformation.dataSourceArmId,
            properties.linkedResourceInformation.linkedResourceId,
            properties.sourceResourceId
        )
    ))
    | where isnotempty(dataSourceId)
    | project dataSourceId, backupItemType = type
)
on $left.resourceId == $right.dataSourceId
| where isnull(dataSourceId)  // Only show storage accounts NOT found in backup vault
| project 
    StorageAccountName = name,
    ResourceGroup = resourceGroup,
    Location = location,
    SubscriptionId = subscriptionId,
    BackupTag = backupTag,
    BackupStatus = "‚ùå No Backup Configured",
    Kind = tostring(properties.kind),
    AccessTier = tostring(properties.accessTier),
    ResourceId = id
| sort by StorageAccountName asc
