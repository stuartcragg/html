// Simple query: Storage accounts without backup that don't have 'backup:none' tag

resources
| where type =~ 'Microsoft.Storage/storageAccounts'
| extend backupTag = tostring(tags['backup'])
| where isnull(tags['backup']) or backupTag != "none"
| extend resourceId = tolower(tostring(id))
| join kind=leftouter (
    RecoveryServicesResources
    | where type =~ 'Microsoft.DataProtection/backupVaults/backupInstances'
    | where tostring(properties.dataSourceInfo.datasourceType) =~ "Microsoft.Storage/storageAccounts/blobServices"
    | extend dataSourceId = tolower(tostring(properties.dataSourceInfo.resourceID))
    | project dataSourceId
)
on $left.resourceId == $right.dataSourceId
| where isnull(dataSourceId)
| project 
    StorageAccountName = name,
    ResourceGroup = resourceGroup,
    Location = location,
    SubscriptionId = subscriptionId,
    BackupTag = backupTag,
    ResourceId = resourceId
| sort by StorageAccountName asc
